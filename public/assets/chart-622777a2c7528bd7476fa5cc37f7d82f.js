var plotHelper=function(){var e={},t="KWh",a=function(e){var a=[];if(null!=e){$.each(e,function(e,o){var n=[];$.each(o,function(e,t){n.push(t)}),a.push({label:"KW"==t?"Consumption":e,data:n.sort()})});var o=$("#startDate").length?Date.parse($("#startDate").val()):null,r=$("#realtime").prop("checked")?Date.now():$("#endDate").length?Date.parse($("#endDate").val()):null;$("#placeholder").length&&$.plot($("#placeholder"),a,{series:{lines:{show:!0},points:{show:!0}},grid:{hoverable:!0,clickable:!0},tooltip:!0,tooltipOpts:{content:"'%s'<br/>%x<br/>%y.2",shifts:{x:-60,y:25}},xaxis:{mode:"time",timeformat:"%d/&#8203;%m/&#8203;%Y<br/>%h:&#8203;%M:&#8203;%S",timezone:"browser",min:o,max:r},yaxis:{tickDecimals:2,axisLabel:t},legend:{container:$("#legend").length?$("#legend"):null}}),$("#vio_div").length&&n(e)}},o=function(e){changed&&(a(e),changed=!1)},n=function(e){if(console.log(e),e["Aggregate: consumption, forecast"]){var t=[];$.each(e["Aggregate: consumption, forecast"],function(a,o){if(e["Aggregate: consumption"][o[0]/1e3]){var n=new Date(o[0]),r=e["Aggregate: consumption"][o[0]/1e3][1],l=o[1],s=r>l;t.push({date:n,actual:r,forecast:l,status:s?"VIOLATION":"SATISFACTION"}),console.log(n,r,l,s)}}),$("#vio_div").html('<hr/>        <table id="violations" class="table">          <thead>          <th>Date</th><th data-dynatable-column="actual">Actual (&euro;)</th>          <th data-dynatable-column="forecast">Forecast (&euro;)</th>          <th>Status</th>          </thead>          <tbody>          </tbody>        </table>');var a=$("#violations").dynatable({dataset:{records:t}}).data("dynatable");a.paginationPage.set(1),a.process(),$("#vio_div").show()}else $("#vio_div").hide()},r=function(e,t,a,o){var n=e.prosumer_name+": "+t;if(null==o[n]&&(o[n]={}),o[n][e.timestamp]=[1e3*e.timestamp,e.actual[t]],a){var n=e.prosumer_name+": "+t+", forecast";null==o[n]&&(o[n]={}),o[n][e.timestamp]=[1e3*e.forecast.timestamp,e.forecast[t]]}return o},l=function(e,t,a){var o={};return null==e?o:($.each(e,function(e,n){o=r(n,t,a,o)}),o)};return{replot:a,readData:l,drawChart:function(n,l,s,i){t="kw"==s?"KW":"KWh","undefined"!=typeof source&&null!=source&&(console.log(source),source.OPEN&&(source.close(),console.log("Closed source"))),source=new EventSource(n),console.log("Connecting to "+n),e=l,changed=!0,$(window).on("resize orientationChanged",function(){a(e)}),source.addEventListener("datapoint",function(t){var a=JSON.parse(t.data);e=r(a,s,i,e),changed=!0,window.setTimeout(o,100,e)}),source.addEventListener("market",function(e){var t=JSON.parse(e.data);console.log("Received market data: ",t),$.plot($("#cost_placeholder"),t.plot,{series:{lines:{show:!0},points:{show:!0}},grid:{hoverable:!0,clickable:!0},tooltip:!0,tooltipOpts:{content:"'%s'<br/>%x<br/>%y.2",shifts:{x:-60,y:25}},xaxis:{mode:"time",timeformat:"%d/&#8203;%m/&#8203;%Y<br/>%h:&#8203;%M:&#8203;%S",timezone:"browser",min:$("#startDate").length?Date.parse($("#startDate").val()):null,max:$("#realtime").prop("checked")?Date.now():$("#endDate").length?Date.parse($("#endDate").val()):null},yaxis:{tickDecimals:2,axisLabel:"&euro;"},legend:{container:$("#legend").length?$("#cost_legend"):null}}),$("#costs_div").html('<hr/><table id="costs_table" class="table table-responsive"><thead><th>Name</th><th data-dynatable-column="forecast">Forecasted Cost (&euro;)</th><th data-dynatable-column="ideal">Cost without penalties (&euro;)</th><th data-dynatable-column="real">Cost with penalties (&euro;)</th></thead><tbody></tbody></table>');var a=$.grep(t.dissagrgated,function(e){return-1==e.id})[0],o=$.grep(t.dissagrgated,function(e){return-2==e.id})[0],n=((a.real-o.real)/a.real*100).toFixed(2),r=a.real-a.ideal,l=o.real-o.ideal,s=((r-l)/r*100).toFixed(2);$("#perc_div").html("<hr/><strong>Cost reduction: </strong> "+n+"%<br/><strong>Penalty reduction: </strong> "+s+"%");var i=$("#costs_table").dynatable({dataset:{records:t.dissagrgated,sorts:{real:-1},perPageDefault:10}}).data("dynatable");i.paginationPage.set(1),i.process()}),o(e)}}}();