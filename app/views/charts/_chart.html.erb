<%= javascript_include_tag "chart" %>

<% startDate = (DateTime.now - 7.days)
   endDate = DateTime.now 
 %>

<div>
  <div id="placeholder" style="width:100%;height:400px;min-width=600px"></div>
  <div id="controls">
    <input id="startDate" type="text" value="<%= startDate %>"/>
    <input id="endDate" type="text" value="<%= endDate %>"/> 
    <strong>Real-time updates?</strong>
    <input id="realtime" type="checkbox" checked>
    <select id="type">
      <option value="production" selected="true">Production</option>
      <option value="consumption">Consumption</option>
      <option value="storage">Storage</option>
    </select>
    <strong>Forecast?</strong>
    <input id="forecast" type="checkbox">
    <button id="subDates"> Set </button>
    <br/>
  </div>
</div>
<script>  
   
    var idata = <%= provider.request_cached(3, startDate, endDate).to_json.html_safe %>;
    $(function(){
        plotHelper.drawChart(
                "<%= stream %>", 
                plotHelper.readData(
                      idata, 
                      $('#type').val(),
                      $('#forecast').is(':checked')), 
                $('#type').val(), 
                $('#forecast').is(':checked'));
        $('#startDate').datetimepicker();
        $('#endDate').datetimepicker();
        $('#endDate').prop('disabled', true);
               
        $('#subDates').click(function () {
         
            var s = $('#startDate').val();
            var e = $('#endDate').prop("disabled") ? '' : $('#endDate').val();
            
              
            var paramObj = {};
            
            if (s) {
              paramObj.startdate = s;
            }
            if (e) {
              paramObj.enddate = e;
            }
             
            var url = "<%= stream %>?" + $.param(paramObj);
            console.log("Conncting to stream: ", url);
            
            plotHelper.drawChart(url, {}, $('#type').val(), $('#forecast').is(':checked'));
      });
      $('#realtime').change(function () {
          if (this.checked) {
            $('#endDate').prop( "disabled", true );
          } else {
            $('#endDate').prop( "disabled", false );
          }
      });
    });
</script>

