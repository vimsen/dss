<div class="row">
  <div class="col-lg-12">
    <h3 class="page-header">Target Clustering</h3>
  </div>
  <!-- /.col-lg-12 -->
</div>

<div class="row">

  <div class="col-lg-12">
    <div class="panel panel-default">
      <div class="panel-heading">
        Target Clustering
      </div><!-- /.panel-heading -->
      <div class="panel-body">

        <form action="#" id="maxvalueform">
          <label>Graph scale</label>
          <input type="text" name="max" value="100" id="maxvalue"/>
        </form>

        <form action="#" id="targetvalueform">
          <label>Target value</label>
          <input type="text" name="target" value="50" id="targetvalue"/>
        </form>

        <div id="placeholder" style="width:600px;height:300px"></div>

        <hr/>
        <div id="prosumer_results"></div>

      </div> <!-- /.panel-body -->
    </div> <!-- /.panel -->
  </div>
</div>

<div class="row">
  <div class="col-lg-12">
    <div class="panel panel-default">
      <div class="panel-heading">
        Run matching algorithm
      </div>
      <div class="panel-body">
        <form action="#" id="run_algorithm">
          <input type="submit" value="Run Algorithm"/>
        </form>
        <div id="progress" class="terminal">

        </div>
      </div>
    </div>
  </div>
</div>

<script>
  $(function () {


    var data = [ { data: <%= @timestamps.map{|ts| [ts.to_i * 1000, 50]}.to_json -%>,
                   label: "Targets", editable: true }];


    var options = {
      series: {
        editMode: 'y',
        lines: {
          show: true
        },
        points: {
          show: true
        }
      },
      grid: {
        hoverable: true,
        clickable: true,
        editable: true
      },
      tooltip: true,
      tooltipOpts: {
        content: "'%s'<br/>%x<br/>%y.2",
        shifts: {
          x: -60,
          y: 25
        }
      },
      xaxis: {
        mode: "time",
        timeformat: "%d/%m/%Y<br/>%h:%M:%S",
        timezone: "browser",
        ticks: 2 /*,
         timeformat : "%y/%m/%d-%h:%M:%S",
         tickSize : [12, "hour"]*/
      },
      yaxis: {
        tickDecimals: 0,
        min: 0,
        max: $("#maxvalue").val()
      },
      legend:{
        container: $("#legend"),
        noColumns: 0
      }
    };

    var plot = $.plot($("#placeholder"), data, options);

    $("#placeholder").bind("datadrop", function(event,pos,item) {
        data[item.seriesIndex].data[item.dataIndex] = [pos.x1,pos.y1];
        plot = $.plot($("#placeholder"), data, options);
    });

    $("#maxvalueform").submit(function () {
      options.yaxis.max = $("#maxvalue").val();
      plot = $.plot($("#placeholder"), data, options);
      return false;
    });

    $("#targetvalueform").submit(function () {
      var target = parseFloat($("#targetvalue").val());
      for (var i = 0; i < data[0].data.length; i++) {
        data[0].data[i][1] = target;
      }
      plot = $.plot($("#placeholder"), data, options);
      return false;
    });

    $("#run_algorithm").submit(function () {
      data[0].editable = false;
      plot = $.plot($("#placeholder"), data, options);

      $("#progress").empty();
      $("#prosumer_results").empty();
      $("#run_algorithm :input").prop("disabled", true);

      var params = {
        startDate: "<%= @startDate -%>",
        endDate: "<%= @endDate -%>",
        interval: "<%= @interval -%>",
        targets: JSON.stringify(data[0].data)
      }

     // alert("/stream/run_algorithm&" + $.param(params));

      var source = new EventSource("/stream/run_algorithm?" + $.param(params));

      source.addEventListener('output', function(e) {
        //   console.log("Datapoint received ", e);
        var message = JSON.parse(e.data);
        $("#progress").append("<BR/>" + message).animate({scrollTop: $('#progress').prop("scrollHeight")}, 5);
      });

      source.addEventListener('result', function(e) {
        var message = JSON.parse(e.data);
        source.close();
        $("#progress").append("<BR/>" + message).an;
        $("#run_algorithm :input").prop("disabled", false);
        data[0].editable = true;
        data[1] = {
          data: message.consumption,
          label: "approximation", editable: false
        };
        plot = $.plot($("#placeholder"), data, options);

        $.each(message.prosumers, function(i,v) {
          if ( ! $('#prosumer_results').is(':empty')) {
            $("#prosumer_results").append(", ");
          }
          $("#prosumer_results").append("<a href='/prosumers/" + v.id + "'>"+ v.name+"</a>");
       //   console.log("<a href='/prosumers/" + v.id + "'>"+ v.name+"</a>,");
        });


      });

      return false;
    });
  });

</script>